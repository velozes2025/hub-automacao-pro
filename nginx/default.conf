# Hub Automacao Pro - Nginx Reverse Proxy
# All services behind a single port (80/443)
#
# Routes:
#   /webhook, /health         -> hub-bot:3000
#   /admin/*                  -> hub-admin:9615
#   /evolution/*              -> hub-evolution:8080 (API only, restricted)
#
# To enable SSL:
#   1. Point a domain to this server's IP
#   2. Uncomment the SSL server block below
#   3. Run: docker compose exec nginx certbot --nginx -d yourdomain.com
#   4. Restart: docker compose restart nginx

upstream bot {
    server hub-bot:3000;
}

upstream admin {
    server hub-admin:9615;
}

upstream evolution {
    server hub-evolution:8080;
}

server {
    listen 80;
    server_name _;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # --- Bot webhook + health ---
    location /webhook {
        proxy_pass http://bot/webhook;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 30s;
    }

    location /health {
        proxy_pass http://bot/health;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # --- Admin Panel ---
    location / {
        proxy_pass http://admin;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
    }

    # --- Evolution API (restricted to webhook source + local) ---
    location /evolution/ {
        # Only allow from trusted sources
        # Uncomment to restrict: allow 127.0.0.1; deny all;
        rewrite ^/evolution/(.*)$ /$1 break;
        proxy_pass http://evolution;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Block common attack paths
    location ~ /\. {
        deny all;
    }

    location ~ ^/(wp-admin|wp-login|xmlrpc) {
        return 444;
    }
}

# --- SSL Server Block (uncomment when domain is ready) ---
# server {
#     listen 443 ssl http2;
#     server_name yourdomain.com;
#
#     ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers HIGH:!aNULL:!MD5;
#
#     # Same location blocks as above...
# }
