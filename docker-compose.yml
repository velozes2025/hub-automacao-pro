services:
  # ============================================
  # PostgreSQL - Banco de Dados Principal
  # ============================================
  postgres:
    image: postgres:15-alpine
    container_name: hub-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-hub_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-hub_secret_2024}
      POSTGRES_DB: ${POSTGRES_DB:-hub_database}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db:/docker-entrypoint-initdb.d:ro
    networks:
      - hub-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-hub_user} -d ${POSTGRES_DB:-hub_database}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # Redis - Cache e Filas (Evolution API)
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: hub-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - hub-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # Evolution API v2 - WhatsApp API
  # ============================================
  evolution:
    image: atendai/evolution-api:v2.2.3
    container_name: hub-evolution
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      # Servidor
      - SERVER_URL=http://104.248.180.81:8080
      - SERVER_PORT=8080

      # Autenticacao
      - AUTHENTICATION_API_KEY=${EVOLUTION_API_KEY:-sua-chave-global-aqui}

      # Banco de dados (PostgreSQL)
      - DATABASE_ENABLED=true
      - DATABASE_PROVIDER=postgresql
      - DATABASE_CONNECTION_URI=postgresql://${POSTGRES_USER:-hub_user}:${POSTGRES_PASSWORD:-hub_secret_2024}@postgres:5432/${POSTGRES_DB:-hub_database}?schema=evolution
      - DATABASE_URL=postgresql://${POSTGRES_USER:-hub_user}:${POSTGRES_PASSWORD:-hub_secret_2024}@postgres:5432/${POSTGRES_DB:-hub_database}?schema=evolution
      - DATABASE_SAVE_DATA_INSTANCE=true
      - DATABASE_SAVE_DATA_NEW_MESSAGE=true
      - DATABASE_SAVE_MESSAGE_UPDATE=true
      - DATABASE_SAVE_DATA_CONTACTS=true
      - DATABASE_SAVE_DATA_CHATS=true

      # Redis para cache
      - CACHE_REDIS_ENABLED=true
      - CACHE_REDIS_URI=redis://redis:6379
      - CACHE_REDIS_PREFIX_KEY=evolution
      - CACHE_LOCAL_ENABLED=false

      # Logs
      - LOG_LEVEL=ERROR,WARN,DEBUG,INFO,LOG,VERBOSE,DARK,WEBHOOKS
      - LOG_BAILEYS=info

      # Instancias
      - DEL_INSTANCE=false

      # Webhook Global (desligado - usamos por instancia)
      - WEBHOOK_GLOBAL_ENABLED=false

      # QR Code
      - QRCODE_LIMIT=30

      # Configuracoes de Sessao
      - CONFIG_SESSION_PHONE_CLIENT=Evolution API
      - CONFIG_SESSION_PHONE_NAME=Chrome
      - CONFIG_SESSION_PHONE_VERSION=

      # Timezone
      - TZ=${TIMEZONE:-America/Sao_Paulo}
    volumes:
      - evolution_instances:/evolution/instances
      - evolution_store:/evolution/store
    networks:
      - hub-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  # ============================================
  # Hub Bot - Platform Multi-Tenant
  # ============================================
  hub-bot:
    build: ./app
    container_name: hub-bot
    restart: unless-stopped
    # Port exposed via nginx reverse proxy (not directly)
    expose:
      - "3000"
    environment:
      - DATABASE_URL=${DATABASE_URL:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY}
      - ELEVENLABS_VOICE_ID=${ELEVENLABS_VOICE_ID:-ASZKXTy56hqkRmqOqckz}
      - EVOLUTION_API_KEY=${EVOLUTION_API_KEY}
      - EVOLUTION_URL=http://evolution:8080
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=${POSTGRES_DB:-hub_database}
      - DB_USER=${POSTGRES_USER:-hub_user}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - DEFAULT_MODEL=${DEFAULT_MODEL:-claude-sonnet-4-20250514}
      - MAX_WEBHOOK_WORKERS=${MAX_WEBHOOK_WORKERS:-20}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - REDIS_URL=redis://redis:6379/1
      - STRIPE_API_KEY=${STRIPE_API_KEY:-}
      - STRIPE_PRICE_ID=${STRIPE_PRICE_ID:-}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET:-}
      - WEBHOOK_BACKUP_URL=${WEBHOOK_BACKUP_URL:-}
      - ENGINE_V60_ENABLED=${ENGINE_V60_ENABLED:-false}
      - ENGINE_V60_MEMORY_ENABLED=${ENGINE_V60_MEMORY_ENABLED:-true}
      - ENGINE_V60_REFLECTION_ENABLED=${ENGINE_V60_REFLECTION_ENABLED:-true}
      - ENGINE_V60_STATE_MACHINE_ENABLED=${ENGINE_V60_STATE_MACHINE_ENABLED:-true}
      - ADMIN_NUMBER=${ADMIN_NUMBER:-}
      - GOOGLE_CALENDAR_ID=${GOOGLE_CALENDAR_ID:-primary}
      - GMAIL_ADDRESS=${GMAIL_ADDRESS:-}
      - GMAIL_APP_PASSWORD=${GMAIL_APP_PASSWORD:-}
      - GMAIL_DISPLAY_NAME=${GMAIL_DISPLAY_NAME:-Hub Automacao}
      - AIRTABLE_API_KEY=${AIRTABLE_API_KEY:-}
      - AIRTABLE_BASE_ID=${AIRTABLE_BASE_ID:-}
    networks:
      - hub-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      evolution:
        condition: service_started

  # ============================================
  # Admin Panel - Gestao de Clientes
  # ============================================
  admin-panel:
    build:
      context: .
      dockerfile: admin/Dockerfile
    container_name: hub-admin
    restart: unless-stopped
    # Port exposed via nginx reverse proxy (not directly)
    expose:
      - "9615"
    environment:
      - DATABASE_URL=${DATABASE_URL:-}
      - EVOLUTION_URL=http://evolution:8080
      - EVOLUTION_API_KEY=${EVOLUTION_API_KEY}
      - BOT_INTERNAL_URL=http://hub-bot:3000
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=${POSTGRES_DB:-hub_database}
      - DB_USER=${POSTGRES_USER:-hub_user}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - SECRET_KEY=${ADMIN_SECRET_KEY:-mude-em-producao}
      - ADMIN_DEFAULT_PASSWORD=${ADMIN_DEFAULT_PASSWORD:-admin123}
    networks:
      - hub-network
    depends_on:
      postgres:
        condition: service_healthy
      evolution:
        condition: service_started

  # ============================================
  # Nginx - Reverse Proxy
  # ============================================
  nginx:
    image: nginx:alpine
    container_name: hub-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - certbot_data:/etc/letsencrypt
    networks:
      - hub-network
    depends_on:
      - hub-bot
      - admin-panel

# ============================================
# Volumes Persistentes
# ============================================
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  evolution_instances:
    driver: local
  evolution_store:
    driver: local
  certbot_data:
    driver: local

# ============================================
# Rede Interna
# ============================================
networks:
  hub-network:
    driver: bridge
    name: hub-automacao-network
